{% extends "base.html" %}
{% block title %}Análises Aéreo — Comparativo{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title mb-0">Comparativo da Fatura</h1>
    <span class="badge bg-dark ms-3 fs-6">Passo 2 de 2</span>
</div>

<section class="card mb-4">
  <div class="card-body p-4">
    <h5 class="card-title mb-3">Envie a planilha de Tabelas (.xlsx)</h5>
    <form method="post" enctype="multipart/form-data" class="row g-3 align-items-end">
      <div class="col-md-6">
        <label class="form-label fw-bold">Planilha de Tabelas</label>
        <input class="form-control" type="file" name="acordos_file" accept=".xlsx" required />
      </div>
      <div class="col-md-3">
        <button class="btn btn-dark w-100" type="submit">Comparar</button>
      </div>
      {% if download_url %}
      <div class="col-md-3 text-md-end">
        <a class="btn btn-success w-100" href="{{ download_url }}">Baixar Resultado Final</a>
      </div>
      {% endif %}
    </form>
  </div>
</section>

<section class="mb-4">
  <h5 class="mb-3">Métricas do Resultado</h5>
  <div class="row g-3">

    <!-- Cobrado — Geral -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="metric-card text-center"
           data-bs-toggle="tooltip"
           data-bs-placement="top"
           title="Somatório de (Frete_Peso × Peso Taxado). Se alguma linha não tiver ambos, usa o Vlr Frete dessa linha. Considera TODAS as linhas (com e sem tarifa).">
        <h6 class="mb-1">Cobrado — Geral</h6>
        <small class="text-muted d-block mb-2"></small>
        <div id="mCobradoGeral" class="val">—</div>
      </div>
    </div>

    <!-- Cobrado — Tarifado -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="metric-card text-center"
           data-bs-toggle="tooltip"
           data-bs-placement="top"
           title="Somatório de (Frete_Peso × Peso Taxado) apenas das linhas com status 'Dentro da tolerância' ou 'Fora da tolerância'.">
        <h6 class="mb-1">Cobrado — Tarifado</h6>
        <small class="text-muted d-block mb-2"></small>
        <div id="mCobrado" class="val">—</div>
      </div>
    </div>

    <!-- Acordado — Simulado -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="metric-card text-center"
           data-bs-toggle="tooltip"
           data-bs-placement="top"
           title="Somatório de (Frete_Acordo × Peso Taxado) apenas das linhas com status 'Dentro da tolerância' ou 'Fora da tolerância'.">
        <h6 class="mb-1">Acordado — Simulado</h6>
        <small class="text-muted d-block mb-2"></small>
        <div id="mSimulado" class="val">—</div>
      </div>
    </div>

    <!-- Diferença (Cobrado − Acordado) -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="metric-card text-center"
           data-bs-toggle="tooltip"
           data-bs-placement="top"
           title="Diferença entre 'Cobrado — Tarifado' e 'Acordado — Simulado'. Calculada só nas linhas com status 'Dentro' ou 'Fora'.">
        <h6 class="mb-1">Diferença (Cobrado − Acordado)</h6>
        <small class="text-muted d-block mb-2"></small>
        <div id="mDiferenca" class="val text-danger">—</div>
      </div>
    </div>

    <!-- % Fora da Tolerância -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="metric-card text-center"
           data-bs-toggle="tooltip"
           data-bs-placement="top"
           title="Proporção de linhas 'Fora da tolerância' sobre o total de linhas consideradas ('Dentro' + 'Fora').">
        <h6 class="mb-1">% Fora da Tolerância</h6>
        <small class="text-muted d-block mb-2"></small>
        <div id="mForaPct" class="val">—</div>
      </div>
    </div>

  </div>

  <!-- Observação opcional -->
  <div class="mt-2">
    <small class="text-muted">
      Observação: todos os indicadores (exceto <strong>Cobrado — Geral</strong>) consideram somente linhas com status
      <em>Dentro da tolerância</em> ou <em>Fora da tolerância</em>.
    </small>
  </div>
</section>

<section class="card">
  <div class="card-body p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title mb-0">Prévia do Resultado ({{ rows }} linhas)</h5>
      <div class="toolbar"></div>
    </div>
    <div class="table-wrapper">
      <div id="table-wrap">
        {{ table_html|safe }}
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  // Habilita tooltips Bootstrap 5
  document.addEventListener('DOMContentLoaded', () => {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
  });
</script>
<script>
  // =========================
  // Utils texto/número
  // =========================
  function stripAccents(s){return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');}
  function normText(s){return stripAccents(s).trim().toLowerCase();}
  function toNum(raw){
    if(raw===undefined||raw===null)return NaN;
    let s=String(raw).trim();
    if(s===''||s==='-'||s==='—')return NaN;
    s=s.replace(/\s/g,'').replace(/R\$/gi,'');
    const hasComma=s.includes(','), hasDot=s.includes('.');
    if(hasComma&&hasDot){
      const lastComma=s.lastIndexOf(','), lastDot=s.lastIndexOf('.');
      const decSep=(lastComma>lastDot)?',':'.', thouSep=(decSep===',')?'.':',';
      s=s.split(thouSep).join('');
      if(decSep===',') s=s.replace(',', '.');
    } else if (hasComma){
      s=s.replace(/\./g,''); s=s.replace(',', '.');
    } else {
      s=s.replace(/,/g,'');
    }
    const v=Number(s); return Number.isFinite(v)?v:NaN;
  }
  const fmtMoney=(n)=>Number.isFinite(n)?n.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}):'—';
  const fmtPct=(n)=>Number.isFinite(n)?n.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})+'%':'—';
  const setText=(id, txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };

  // =========================
  // Preparação da tabela
  // =========================
  const wrap=document.getElementById('table-wrap');
  const tbl=wrap?wrap.querySelector('table'):null;
  if(tbl){tbl.id='result-table'; tbl.classList.add('table','table-striped','table-hover','align-middle');}

  function headerIndex(name){
    const ths=document.querySelectorAll('#result-table thead th');
    const target=(name||'').toLowerCase();
    for(let i=0;i<ths.length;i++){ if(ths[i].textContent.trim().toLowerCase()===target) return i; }
    return -1;
  }
  function pickIdx(cands){ for(const c of cands){ const i=headerIndex(c); if(i>=0)return i; } return -1; }

  // =========================
  // Status helpers
  // =========================
  const isDentroTol=(t)=>{const s=normText(t);return s.includes('dentro')&&s.includes('tolerancia');}
  const isForaTol  =(t)=>{const s=normText(t);return s.includes('fora')  &&s.includes('tolerancia');}

  // =========================
  // Núcleo do cálculo (aplica filtro por status)
  // =========================
  function aggregateRows(getCell){
    // Índices das colunas relevantes
    const idxFretePeso   = pickIdx(['Frete Peso','Frete_Peso','FretePeso']);
    const idxPesoTaxado  = pickIdx(['Peso Taxado','Peso_Taxado','PesoTaxado']);
    const idxFreteAcordo = pickIdx(['Frete_Tabela','Frete Tabela','Valor Tabela','Vlr Tabela','Tabela']);
    const idxVlrFrete    = pickIdx(['Vlr Frete','VlrFrete','Valor Frete','Frete']);
    const idxStatus      = pickIdx(['Status_Tolerância','Status Tolerância','Status_Tolerancia','Status']);

    const rows = getCell.rows(); // array de índices (DT) ou TRs (plain)
    let totalCobradoTarifado=0, totalCobradoGeral=0, totalSimulado=0;
    let dentro=0, fora=0;

    rows.forEach(r=>{
      const vFretePeso = idxFretePeso  >=0 ? toNum(getCell.value(r, idxFretePeso))   : NaN;
      const vPeso      = idxPesoTaxado >=0 ? toNum(getCell.value(r, idxPesoTaxado))  : NaN;
      const vAcordoKg  = idxFreteAcordo>=0 ? toNum(getCell.value(r, idxFreteAcordo)) : NaN;
      const vFreteRaw  = idxVlrFrete   >=0 ? toNum(getCell.value(r, idxVlrFrete))    : NaN;
      const statusTxt  = idxStatus     >=0 ? getCell.value(r, idxStatus)             : '';

      const ehConsiderado = isDentroTol(statusTxt) || isForaTol(statusTxt);
      const produto = (Number.isFinite(vFretePeso) && Number.isFinite(vPeso)) ? vFretePeso * vPeso : NaN;

      // Total Cobrado — Geral: inclui todas as linhas (produto; fallback para Vlr Frete)
      if(Number.isFinite(produto)) totalCobradoGeral += produto;
      else if(Number.isFinite(vFreteRaw)) totalCobradoGeral += vFreteRaw;

      // >>> SOMENTE DENTRO/FORA <<<
      if(ehConsiderado){
        // Total Cobrado (Vlr Frete) = Frete_Peso × Peso_Taxado (sem fallback)
        if(Number.isFinite(produto)) totalCobradoTarifado += produto;

        // Simulação do Acordado = Frete_Acordo × Peso_Taxado
        if(Number.isFinite(vAcordoKg) && Number.isFinite(vPeso)){
          totalSimulado += vAcordoKg * vPeso;
        }

        if(isDentroTol(statusTxt)) dentro++;
        else if(isForaTol(statusTxt)) fora++;
      }
    });

    const considerados = dentro + fora;
    const foraPct = considerados ? (fora/considerados)*100 : NaN;
    const totalDiferenca = (Number.isFinite(totalCobradoTarifado)&&Number.isFinite(totalSimulado))
      ? (totalCobradoTarifado - totalSimulado) : NaN;

    return { totalCobradoTarifado, totalCobradoGeral, totalSimulado, totalDiferenca, foraPct };
  }

  // =========================
  // DataTables
  // =========================
  function computeMetricsFromDT(dt){
    const getCell = {
      rows: ()=> dt.rows({search:'applied'}).indexes().toArray(),
      value: (r,c)=> dt.cell(r,c).data()
    };
    const agg = aggregateRows(getCell);

    setText('mCobrado',      fmtMoney(agg.totalCobradoTarifado));  // só Dentro/Fora
    setText('mCobradoGeral', fmtMoney(agg.totalCobradoGeral));     // todas as linhas
    setText('mSimulado',     fmtMoney(agg.totalSimulado));         // só Dentro/Fora
    setText('mDiferenca',    fmtMoney(agg.totalDiferenca));        // só Dentro/Fora
    setText('mForaPct',      fmtPct(agg.foraPct));                 // só Dentro/Fora
  }

  // =========================
  // Fallback sem DataTables
  // =========================
  function computeMetricsFromPlainTable(){
    if(!tbl) return;
    const getCell = {
      rows: ()=> Array.from(tbl.querySelectorAll('tbody tr')),
      value: (tr, idx)=> {
        const td = tr.querySelectorAll('td')[idx];
        return td ? td.textContent : '';
      }
    };
    const agg = aggregateRows(getCell);

    setText('mCobrado',      fmtMoney(agg.totalCobradoTarifado));  // só Dentro/Fora
    setText('mCobradoGeral', fmtMoney(agg.totalCobradoGeral));     // todas as linhas
    setText('mSimulado',     fmtMoney(agg.totalSimulado));         // só Dentro/Fora
    setText('mDiferenca',    fmtMoney(agg.totalDiferenca));        // só Dentro/Fora
    setText('mForaPct',      fmtPct(agg.foraPct));                 // só Dentro/Fora
  }

  // =========================
  // Init
  // =========================
  if(tbl){
    let dt=null;
    if(window.jQuery && jQuery.fn && jQuery.fn.dataTable){
      dt=jQuery('#result-table').DataTable({
        responsive:true, paging:true, searching:true,
        pageLength:25, lengthMenu:[10,25,50,100,500],
        dom:'<"row mb-2"<"col-md-6"l><"col-md-6 text-md-end"Bf>>t<"row mt-2"<"col-md-6"i><"col-md-6"p>>',
        buttons:[
          {extend:'copyHtml5', className:'btn btn-dark', text:'Copiar'},
          {extend:'csvHtml5',  className:'btn btn-dark', text:'CSV'},
          {extend:'excelHtml5',className:'btn btn-dark', text:'Excel'}
        ],
        language:{url:'https://cdn.datatables.net/plug-ins/2.0.7/i18n/pt-BR.json'}
      });
      const tb=document.querySelector('.dt-buttons'); const toolbar=document.querySelector('.toolbar');
      if(tb&&toolbar) toolbar.appendChild(tb);
      computeMetricsFromDT(dt);
      dt.on('draw',()=>computeMetricsFromDT(dt));
    } else {
      computeMetricsFromPlainTable();
    }
  }
</script>
{% endblock %}