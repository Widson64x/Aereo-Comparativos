{% extends "base.html" %}
{% block title %}Fatura Comparativo — Início{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4" data-aos="fade-down">
  <h1 class="page-title mb-0">Fatura Comparativo</h1>
</div>

<div class="card" data-aos="fade-up">
  <div class="card-body p-4">
    <h5 class="card-title mb-3">Selecione o ponto de partida</h5>

    <ul class="steps mb-4">
      <li class="done">Upload do PDF</li>
      <li>Pré-processamento</li>
      <li>Comparativo</li>
    </ul>

    <div class="mb-4" id="step-options">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="flow-option" id="option-new-pdf" value="new" checked>
        <label class="form-check-label" for="option-new-pdf"><strong>1. Enviar um novo PDF</strong></label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="flow-option" id="option-existing-pdf" value="existing" {% if not recent_files %}disabled{% endif %}>
        <label class="form-check-label" for="option-existing-pdf"><strong>2. Usar um PDF do histórico</strong></label>
      </div>
    </div>

    <form method="post" action="{{ url_for('fatura.process_pdf') }}" enctype="multipart/form-data" id="form-new-pdf" data-aos="fade-up" data-no-auto-submit>
      <p>Extraia os dados de uma nova fatura para iniciar a comparação.</p>
      <div class="row g-3">
        <div class="col-12 col-md-8">
          <label class="form-label fw-bold">Arquivo PDF</label>
          <input class="form-control" type="file" name="pdf_file" accept=".pdf" required />
          <div class="form-text">Apenas as páginas de detalhamento serão lidas.</div>
        </div>
        <div class="col-12 col-md-4 d-grid align-self-center">
          <button class="btn btn-dark btn-lg" type="submit">Processar Novo PDF</button>
        </div>
      </div>
    </form>

    <form method="post" action="{{ url_for('fatura.use_existing_pdf') }}" id="form-existing-pdf" class="d-none" data-aos="fade-up">
      <p>Selecione um PDF já enviado para pular a etapa de upload e ir direto para a comparação.</p>
      {% if recent_files %}
      <div class="row g-3">
        <div class="col-12 col-md-8">
          <label for="existing_pdf_select" class="form-label fw-bold">PDFs Recentes</label>
          <select class="form-select" name="existing_pdf" id="existing_pdf_select" required>
            <option value="" disabled selected>Selecione um arquivo do histórico...</option>
            {% for file in recent_files %}
              <option value="{{ file }}">{{ file }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-4 d-grid align-self-end">
          <button class="btn btn-dark btn-lg" type="submit">Usar PDF Selecionado</button>
        </div>
      </div>
      {% else %}
      <div class="alert alert-secondary">
        Nenhum PDF encontrado no histórico. Por favor, envie um novo arquivo para começar.
      </div>
      {% endif %}
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const optionNew = document.getElementById('option-new-pdf');
  const optionExisting = document.getElementById('option-existing-pdf');
  const formNew = document.getElementById('form-new-pdf');
  const formExisting = document.getElementById('form-existing-pdf');
  function toggleForms() {
    if (optionNew.checked) { formNew.classList.remove('d-none'); formExisting.classList.add('d-none'); }
    else { formNew.classList.add('d-none'); formExisting.classList.remove('d-none'); }
  }
  optionNew?.addEventListener('change', toggleForms);
  optionExisting?.addEventListener('change', toggleForms);
  toggleForms();
});
</script>
{% endblock %}
