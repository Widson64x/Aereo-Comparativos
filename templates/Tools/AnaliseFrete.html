{% extends "Base.html" %}
{% block title %}Análises Aéreo — Comparativo{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link href="{{ url_for('static', filename='css/AnaliseFrete.css') }}" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="analysis-page-container">
    <div class="page-header" data-aos="fade-down">
        <div>
            <h1 class="page-title">Análise Comparativa de Fatura</h1>
            <p class="page-subtitle">Faça o upload da planilha de tabelas para comparar com os dados da fatura.</p>
        </div>
        <div class="stepper">
            <div class="step"><span>1</span> Importar Fatura</div>
            <div class="step active"><span>2</span> Comparar Tabelas</div>
        </div>
    </div>

    <section class="card upload-section" data-aos="fade-up">
        <div class="card-body p-4">
            <form id="upload-form" method="post" enctype="multipart/form-data" class="row g-3 align-items-center">
                <div class="col-lg-6">
                    <label for="acordos_file_input" class="dropzone-area">
                        <div class="dropzone-icon"><i class="bi bi-cloud-arrow-up-fill"></i></div>
                        <div class="dropzone-text">
                            <strong>Arraste e solte a planilha de Tabelas aqui</strong>
                            <span>ou clique para selecionar o arquivo (.xlsx)</span>
                        </div>
                        <span id="file-name-display" class="file-name-display"></span>
                    </label>
                    <input class="form-control" type="file" name="acordos_file" id="acordos_file_input" accept=".xlsx" required hidden />
                </div>

                <div class="col-lg-3">
                    <button class="btn btn-primary w-100" type="submit">
                        <i class="bi bi-bar-chart-line-fill me-2"></i>Comparar Agora
                    </button>
                </div>

                {% if download_url %}
                <div class="col-lg-3">
                    <div class="download-box">
                        <div class="btn-group w-100">
                            <a class="btn btn-success" data-dl="server" data-basehref="{{ download_url }}" href="{{ download_url }}" download>
                                <i class="bi bi-file-earmark-spreadsheet-fill me-1"></i> Baixar XLSX
                            </a>
                            <a class="btn btn-outline-success" data-dl="server" data-basehref="{{ download_url }}?format=csv" href="{{ download_url }}?format=csv" download>
                                CSV
                            </a>
                        </div>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="zerosSwitch">
                            <label class="form-check-label" for="zerosSwitch">Exportar nulos como 0</label>
                        </div>
                        <small class="text-muted d-block mt-1 text-center">Batch: {{ batch_id }}</small>
                    </div>
                </div>
                {% endif %}
            </form>
        </div>
    </section>
    {% if metrics %}  {# <--- Adicione esta verificação #}
    <div data-aos="fade-up" data-aos-delay="100">
        <div class="kpi-header">
            <i class="bi bi-globe2 text-secondary"></i>
            <h5>Visão Geral</h5>
        </div>
        <div class="row g-4">
            <div class="col-12 col-md-6">
                <div class="metric-card" data-bs-toggle="tooltip" title="Somatório de Vlr Frete para TODAS as linhas.">
                    <div class="metric-icon" style="color: #8b5cf6;"><i class="bi bi-cash-stack"></i></div>
                    <div class="metric-content">
                        <h6>Valor Total Cobrado (Geral)</h6>
                        <div id="mCobradoGeral" class="val">{{ metrics.total_cobrado_geral | format_currency }}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="metric-card" data-bs-toggle="tooltip" title="Diferença entre o 'Valor Total Cobrado (Geral)' e o 'Cobrado — Tarifado'.">
                    <div class="metric-icon" style="color: #f97316;"><i class="bi bi-search"></i></div>
                    <div class="metric-content">
                        <h6>Valores a Verificar</h6>
                        <div id="mValoresAVerificar" class="val">{{ metrics.total_valores_a_verificar | format_currency }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="kpi-header mt-4">
            <i class="bi bi-check-circle-fill text-primary"></i>
            <h5>Simulados (Linhas Tarifadas)</h5>
        </div>
        <div class="row g-4">
            <div class="col-12 col-md-6 col-lg-3">
                <div class="metric-card" data-bs-toggle="tooltip" title="Somatório de Vlr Frete apenas em linhas com status 'Cobrado - Tarifado' ou 'Acordado - Simulado' da tolerância.">
                    <div class="metric-icon" style="color: #3b82f6;"><i class="bi bi-file-earmark-text"></i></div>
                    <div class="metric-content">
                        <h6>Cobrado — Tarifado</h6>
                        <div id="mCobrado" class="val">{{ metrics.total_cobrado_tarifado | format_currency }}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="metric-card" data-bs-toggle="tooltip" title="Somatório de Frete_Tabela (valor da tabela) nas linhas com status 'Cobrado - Tarifado' ou 'Acordado - Simulado'.">
                    <div class="metric-icon" style="color: #16a34a;"><i class="bi bi-file-earmark-ruled"></i></div>
                    <div class="metric-content">
                        <h6>COBRADO - TARIFADO</h6>
                        <div id="mSimulado" class="val">{{ metrics.total_simulado | format_currency }}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="metric-card" data-bs-toggle="tooltip" title="Diferença entre 'Cobrado — Tarifado' e 'COBRADO - TARIFADO'.">
                    <div class="metric-icon" style="color: #ef4444;"><i class="bi bi-graph-down-arrow"></i></div>
                    <div class="metric-content">
                        <h6>Diferença</h6>
                        {% set diff_color = 'text-success' if metrics.total_diferenca < 0 else 'text-danger' if metrics.total_diferenca > 0 else '' %}
                        <div id="mDiferenca" class="val {{ diff_color }}">{{ metrics.total_diferenca | format_currency }}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="metric-card" data-bs-toggle="tooltip" title="Variação percentual da diferença em relação ao valor acordado.">
                    <div class="metric-icon" style="color: #eab308;"><i class="bi bi-percent"></i></div>
                    <div class="metric-content">
                        <h6>% Diferença</h6>
                        <div id="mForaPct" class="val">{{ metrics.pct_diff | format_percent }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="kpi-header mt-4">
            <i class="bi bi-exclamation-triangle-fill text-warning"></i>
            <h5>Valores Verificados</h5>
        </div>
        <div class="row g-4">
            <div class="col-12 col-md-4">
                <div class="metric-card" data-bs-toggle="tooltip" title="Total cobrado das linhas com Status = 'Tarifa Não Localizada'.">
                    <div class="metric-icon" style="color: #64748b;"><i class="bi bi-file-earmark-x"></i></div>
                    <div class="metric-content">
                        <h6>Cobrado sem Tarifa</h6>
                        <div id="mCobradoSemTarifa" class="val">{{ metrics.total_sem_tarifa | format_currency }}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="metric-card" data-bs-toggle="tooltip" title="Total cobrado nas linhas com Status = 'Devolução'.">
                    <div class="metric-icon" style="color: #14b8a6;"><i class="bi bi-arrow-return-left"></i></div>
                    <div class="metric-content">
                        <h6>Valor de Devolução</h6>
                        <div id="mDevValor" class="val">{{ metrics.total_devolucao | format_currency }}</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="metric-card" data-bs-toggle="tooltip" title="Total cobrado nas linhas com Status = 'Frete Mínimo'.">
                    <div class="metric-icon" style="color: #d946ef;"><i class="bi bi-shield-check"></i></div>
                    <div class="metric-content">
                        <h6>Frete Mínimo</h6>
                        <div id="mFreteMinimo" class="val">{{ metrics.total_frete_minimo | format_currency }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}  {# <--- Feche a verificação aqui #}
    <section class="card data-table-section" data-aos="fade-up" data-aos-delay="200">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Prévia do Resultado ({{ rows|default(0) }} linhas)</h5>
                <div class="toolbar"></div>
            </div>
            <div class="table-wrapper">
                <div id="table-wrap">
                    {% if table_html %}
                        {{ table_html|safe }}
                    {% else %}
                        <div class="empty-state">
                            <i class="bi bi-table"></i>
                            <p>A tabela de resultados aparecerá aqui após o processamento.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Inicializar Tooltips do Bootstrap
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el, { container: 'body' }));

    // ===== Lógica da Dropzone =====
    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('acordos_file_input');
    const dropzoneArea = document.querySelector('.dropzone-area');
    const fileNameDisplay = document.getElementById('file-name-display');

    if (dropzoneArea) {
        dropzoneArea.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
                dropzoneArea.classList.add('has-file');
            }
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzoneArea.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropzoneArea.addEventListener(eventName, () => dropzoneArea.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropzoneArea.addEventListener(eventName, () => dropzoneArea.classList.remove('dragover'), false);
        });

        dropzoneArea.addEventListener('drop', e => {
            fileInput.files = e.dataTransfer.files;
            const changeEvent = new Event('change');
            fileInput.dispatchEvent(changeEvent);
        }, false);
    }
    
    // ===== Lógica do Download Switch (Exportar nulos como 0) =====
    const zerosSwitch = document.getElementById('zerosSwitch');
    function syncServerLinks(){
      const links = document.querySelectorAll('a[data-dl="server"]');
      links.forEach(a=>{
        const base = a.getAttribute('data-basehref') || a.getAttribute('href') || '';
        try{
          const url = new URL(base, window.location.origin);
          if(zerosSwitch && zerosSwitch.checked) url.searchParams.set('zeros','1');
          else url.searchParams.delete('zeros');
          a.setAttribute('href', url.pathname + url.search);
        }catch(e){
          // Fallback para URLs relativas
          if(zerosSwitch && zerosSwitch.checked){
            a.setAttribute('href', base + (base.includes('?')?'&':'?') + 'zeros=1');
          }else{
            a.setAttribute('href', base.replace(/([?&])zeros=1(&|$)/,'$1').replace(/[?&]$/,''));
          }
        }
      });
    }
    if(zerosSwitch){ zerosSwitch.addEventListener('change', syncServerLinks); }
    syncServerLinks();

    // ===== Inicialização do DataTables =====
    const wrap=document.getElementById('table-wrap');
    const tbl=wrap?wrap.querySelector('table'):null;
    if(tbl){
        tbl.id='result-table'; 
        tbl.classList.add('table','table-striped','table-hover','align-middle');
        
        // A função de exportação agora APENAS formata para o DataTables/export
        const exportFormatter = (d,c) => {
          const z = document.getElementById('zerosSwitch');
          if(!z || !z.checked) return d;
          
          // Lógica de cabeçalho mantida apenas para a exportação de 0's, 
          // pois o Python já formatou a tabela para exibição
          const ths = document.querySelectorAll('#result-table thead th');
          const head = ths[c]?.textContent || '';
          const h = (head||'').trim().toLowerCase();
          const looksNum = [
            'vlr frete','vlr_frete','frete_peso','peso taxado','frete_tabela',
            'vlr_frete_peso_tabela','diferenca_frete','diferença_frete','diferenca_frete_peso',
          ].some(k => h.includes(k.replace(/_/g, ' '))); // Adaptação para sanitização no header
          
          if(looksNum){
            const s = (d ?? '').toString().trim();
            // Verifica se o valor formatado para exibição é um hífen de valor nulo
            if(s==='' || s==='—' || s==='-') return '0';
          }
          return d;
        }

        if(window.jQuery && jQuery.fn && jQuery.fn.dataTable){
             jQuery('#result-table').DataTable({
               responsive: false, // Desabilitado para permitir rolagem horizontal controlada
               paging:true, searching:true,
               pageLength:25, lengthMenu:[10,25,50,100,500],
               // Remove a função de recompute, pois as métricas são do backend
               dom:'<"row mb-2"<"col-md-6"l><"col-md-6"f>>t<"row mt-2"<"col-md-6"i><"col-md-6"p>>', 
               buttons: [
                 {
                   extend: 'csvHtml5',
                   className: 'btn btn-outline-secondary',
                   text: '<i class="bi bi-file-earmark-csv me-1"></i> CSV',
                   // Usa o exportFormatter para tratar o 'zerosSwitch'
                   exportOptions: { rows: ':visible', format: { body: (d,r,c,n)=> exportFormatter(d,c) }} 
                 },
                 {
                   extend: 'excelHtml5',
                   className: 'btn btn-outline-secondary',
                   text: '<i class="bi bi-file-earmark-excel me-1"></i> Excel',
                   // Usa o exportFormatter para tratar o 'zerosSwitch'
                   exportOptions: { rows: ':visible', format: { body: (d,r,c,n)=> exportFormatter(d,c) }} 
                 },
                 {
                   extend: 'copyHtml5',
                   className: 'btn btn-outline-secondary',
                   text: '<i class="bi bi-clipboard-check me-1"></i> Copiar',
                   exportOptions: { rows: ':visible' }
                 }
               ],
               language: {
                 url: 'https://cdn.datatables.net/plug-ins/2.0.7/i18n/pt-BR.json'
               }
             });

             // Mover botões para a toolbar criada
             jQuery('.toolbar').html(jQuery('#result-table').DataTable().buttons().container());
        }
    }
});
</script>
{% endblock %}