{% extends "Base.html" %}
{% block title %}Análises Aéreo — Padronizador de Tabelas{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4" data-aos="fade-down">
  <h1 class="page-title mb-0">Padronizador de Tabelas</h1>
  <span class="badge bg-dark ms-3 fs-6">Passo 1 de 1</span>
</div>

<section class="card mb-4" data-aos="fade-up">
  <div class="card-body p-4">
    <h5 class="card-title mb-3">Envie a planilha de Tabelas (.xlsx)</h5>
    <form method="post" enctype="multipart/form-data" class="row g-3 align-items-end" data-no-auto-submit>
      <div class="col-md-6">
        <label class="form-label fw-bold">Planilha de Tabelas</label>
        <input class="form-control" type="file" name="arquivo" accept=".xlsx,.xls" required />
      </div>
      <div class="col-md-3">
        <button class="btn btn-dark w-100" type="submit">Padronizar</button>
      </div>

      {% if download_csv_url or download_xlsx_url %}
      <div class="col-md-3 text-md-end d-grid gap-2 d-md-block">
        {% if download_csv_url %}
          <a class="btn btn-success me-1" href="{{ download_csv_url }}">Baixar CSV</a>
        {% endif %}
        {% if download_xlsx_url %}
          <a class="btn btn-outline-success" href="{{ download_xlsx_url }}">Baixar XLSX</a>
        {% endif %}
      </div>
      {% endif %}
    </form>
  </div>
</section>

{% if table_html %}
<section class="mb-4" data-aos="fade-up" data-aos-delay="50">
  <h5 class="mb-3">Métricas</h5>
  <div class="row g-3">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="metric-card text-center" data-bs-toggle="tooltip" title="Total de linhas da prévia mostrada na tabela.">
        <h6>Total de Linhas</h6>
        <div id="mTotal" class="val" data-count-to="{{ rows or 0 }}">{{ rows or 0 }}</div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="metric-card text-center" data-bs-toggle="tooltip" title="Quantidade de origens distintas nas linhas visíveis.">
        <h6>Origens únicas</h6>
        <div id="mOrigens" class="val" data-count-to="0">—</div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="metric-card text-center" data-bs-toggle="tooltip" title="Quantidade de destinos distintos nas linhas visíveis.">
        <h6>Destinos únicas</h6>
        <div id="mDestinos" class="val" data-count-to="0">—</div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="metric-card text-center" data-bs-toggle="tooltip" title="Quantidade de tipos de serviço distintos nas linhas visíveis.">
        <h6>Tipos de Serviço</h6>
        <div id="mServicos" class="val" data-count-to="0">—</div>
      </div>
    </div>

    <!-- Valor_Frete — Média Geral -->
    <div class="col-12 col-md-6 col-lg-3">
      <div id="cardTarifaGeral"
          class="metric-card text-center metric-card--tall"
          data-bs-toggle="tooltip"
          title="Média aritmética da coluna Valor_Frete (R$/kg) nas linhas visíveis da tabela.">
        <h6 class="mb-1">Valor_Frete — Média Geral</h6>
        <small class="text-muted d-block mb-2"> </small>
        <div id="mTarifaMediaGeral" class="val">—</div>
      </div>
    </div>

    <!-- Valor_Frete — Média por Origem -->
    <div class="col-12 col-md-6 col-lg-3">
      <div id="cardTarifaOrigem"
          class="metric-card text-center metric-card--tall"
          data-bs-toggle="tooltip"
          title="Média aritmética da coluna Valor_Frete (R$/kg) filtrada pela origem selecionada. Respeita os filtros da tabela.">
        <h6 class="mb-1">Valor_Frete — Média por Origem</h6>
        <div class="d-flex justify-content-center gap-2 align-items-center mb-2">
          <label for="selOrigem" class="visually-hidden">Origem</label>
          <select id="selOrigem" class="form-select form-select-sm">
            <option value="">Selecione a origem…</option>
          </select>
        </div>
        <div id="mTarifaMediaOrigem" class="val">—</div>
      </div>
    </div>

  </div>
</section>

<section class="card" data-aos="fade-up" data-aos-delay="100">
  <div class="card-body p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title mb-0">Prévia ({{ preview_count or 0 }} linhas)</h5>
      <div class="toolbar"></div>
    </div>
    <div class="table-wrapper">
      <div id="table-wrap">
        {{ table_html|safe }}
      </div>
    </div>
  </div>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
{% if table_html %}
<script>
  // ===== helpers comuns =====
  const wrap = document.getElementById('table-wrap');
  const tbl  = wrap ? wrap.querySelector('table') : null;
  if (tbl) { tbl.id = 'result-table'; tbl.classList.add('table','table-striped','table-hover','align-middle'); }

  function headerIndex(name){
    const ths=document.querySelectorAll('#result-table thead th');
    const target=(name||'').toLowerCase();
    for(let i=0;i<ths.length;i++){ if(ths[i].textContent.trim().toLowerCase()===target) return i; }
    return -1;
  }
  function pickIdx(cands){ for(const c of cands){ const i=headerIndex(c); if(i>=0) return i; } return -1; }

  function toNum(raw){
    if(raw===undefined||raw===null) return NaN;
    let s=String(raw).trim();
    if(s===''||s==='-'||s==='—') return NaN;
    s=s.replace(/\s/g,'').replace(/R\$/gi,'');
    const hasComma=s.includes(','), hasDot=s.includes('.');
    if(hasComma&&hasDot){
      const lastComma=s.lastIndexOf(','), lastDot=s.lastIndexOf('.');
      const decSep=(lastComma>lastDot)?',':'.', thouSep=(decSep===',')?'.':',';
      s=s.split(thouSep).join('');
      if(decSep===',') s=s.replace(',', '.');
    } else if (hasComma){
      s=s.replace(/\./g,''); s=s.replace(',', '.');
    } else {
      s=s.replace(/,/g,'');
    }
    const v=Number(s); return Number.isFinite(v)?v:NaN;
  }
  const fmtMoney = (n) => Number.isFinite(n)
  ? ('R$ ' + n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }))
  : '—';
  const setText=(id, txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };

  // ===== KPIs básicos (únicos) =====
  (function seedBasicCounts(){
    if(!tbl) return;
    const uniq = arr => Array.from(new Set(arr.filter(Boolean)));
    const idxO=headerIndex('Origem'), idxD=headerIndex('Destino'), idxT=headerIndex('Tipo_Servico');
    const rows = [...tbl.querySelectorAll('tbody tr')];
    const o=[],d=[],t=[];
    rows.forEach(tr=>{
      const td = tr.querySelectorAll('td');
      if(idxO>=0) o.push(td[idxO]?.textContent.trim());
      if(idxD>=0) d.push(td[idxD]?.textContent.trim());
      if(idxT>=0) t.push(td[idxT]?.textContent.trim());
    });
    const set=(id,v)=>{const el=document.getElementById(id); if(el){ el.setAttribute('data-count-to', v); el.textContent=v; }};
    set('mOrigens',  uniq(o).length);
    set('mDestinos', uniq(d).length);
    set('mServicos', uniq(t).length);
  })();

  // ===== NOVOS KPIs: médias de tarifa =====
  const ORIGEM_CANDS = ['Origem'];

  // Tarifa = Valor_Frete (prioridade máxima) + fallback p/ nomes antigos, se aparecerem
  const TARIFA_CANDS = [
    'Valor_Frete',
    'Valor Frete', 'Tarifa', 'Tarifa/kg', 'Preço', 'Preço/kg', 'Preco', 'Preco/kg',
    'Frete_Acordo','Frete Acordo','Valor Acordo','Vlr Acordo','Valor'
  ];

  function buildTarifaKPIs(getRows, getCell){
    const idxOrigem = pickIdx(ORIGEM_CANDS);
    const idxTarifa = pickIdx(TARIFA_CANDS);
    const sel = document.getElementById('selOrigem');

    // sem coluna de tarifa => limpa e sai
    if(idxTarifa < 0){
      setText('mTarifaMediaGeral','—');
      if(sel){ sel.innerHTML = '<option value="">Selecione a origem…</option>'; }
      setText('mTarifaMediaOrigem','—');
      return;
    }

    // coleta dados das linhas visíveis
    const rows = getRows();
    const tariffs = [];
    const byOrigin = new Map(); // origem -> [tarifas]

    rows.forEach(r=>{
      const tarifa = toNum(getCell(r, idxTarifa));
      if(!Number.isFinite(tarifa)) return;

      tariffs.push(tarifa);

      if(idxOrigem >= 0){
        const origem = String(getCell(r, idxOrigem)||'').trim();
        if(!byOrigin.has(origem)) byOrigin.set(origem, []);
        byOrigin.get(origem).push(tarifa);
      }
    });

    // média geral
    const mean = (arr)=> arr && arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : NaN;
    setText('mTarifaMediaGeral', fmtMoney(mean(tariffs)));

    // popula seletor de origem (mantém seleção anterior se possível)
    if(sel){
      const prev = sel.value;
      const origins = Array.from(byOrigin.keys()).filter(Boolean).sort((a,b)=>a.localeCompare(b,'pt-BR'));
      sel.innerHTML = '<option value="">Selecione a origem…</option>' + origins.map(o=>`<option>${o}</option>`).join('');
      if(prev && origins.includes(prev)) sel.value = prev;

      // atualiza KPI por origem
      const updateOriginKPI = ()=>{
        const o = sel.value;
        if(!o){ setText('mTarifaMediaOrigem','—'); return; }
        const arr = byOrigin.get(o) || [];
        setText('mTarifaMediaOrigem', fmtMoney(mean(arr)));
      };
      // anexa listener uma vez
      if(!sel._listenerAttached){
        sel.addEventListener('change', updateOriginKPI);
        sel._listenerAttached = true;
      }
      updateOriginKPI();
    }
  }

  // ===== DataTables + integração com KPIs =====
  let dt = null;
  if(window.jQuery && jQuery.fn && jQuery.fn.dataTable && tbl){
    dt = jQuery('#result-table').DataTable({
      responsive:true, paging:true, searching:true,
      pageLength:25, lengthMenu:[10,25,50,100,500],
      dom:'<"row mb-2"<"col-md-6"l><"col-md-6 text-md-end"Bf>>t<"row mt-2"<"col-md-6"i><"col-md-6"p>>',
      buttons:[
        {extend:'copyHtml5', className:'btn btn-dark', text:'Copiar'},
        {extend:'csvHtml5',  className:'btn btn-dark', text:'CSV'},
        {extend:'excelHtml5',className:'btn btn-dark', text:'Excel'}
      ],
      language:{url:'https://cdn.datatables.net/plug-ins/2.0.7/i18n/pt-BR.json'}
    });
    const tb=document.querySelector('.dt-buttons'); const toolbar=document.querySelector('.toolbar');
    if(tb&&toolbar) toolbar.appendChild(tb);

    const getRowsDT = ()=> dt.rows({search:'applied'}).indexes().toArray();
    const getCellDT = (r,c)=> dt.cell(r,c).data();

    // inicial e a cada redraw
    buildTarifaKPIs(getRowsDT, getCellDT);
    dt.on('draw', ()=> buildTarifaKPIs(getRowsDT, getCellDT));
  } else if(tbl){
    // Fallback sem DataTables
    const getRowsPlain = ()=> Array.from(tbl.querySelectorAll('tbody tr'));
    const getCellPlain = (tr, idx)=> {
      const td = tr.querySelectorAll('td')[idx];
      return td ? td.textContent : '';
    };
    buildTarifaKPIs(getRowsPlain, getCellPlain);
  }

  // Habilita tooltips Bootstrap 5
  document.addEventListener('DOMContentLoaded', () => {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
  });
</script>
{% endif %}
{% endblock %}
